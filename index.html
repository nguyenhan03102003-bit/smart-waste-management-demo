<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Ph·∫ßn m·ªÅm Qu·∫£n l√Ω R√°c Th√¥ng minh</title>
    <!-- Tailwind CSS CDN ƒë·ªÉ t·∫°o giao di·ªán ƒë·∫πp v√† responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* M√†u n·ªÅn t·ªëi */
            color: #e2e8f0; /* M√†u ch·ªØ s√°ng */
        }
        #map {
            height: 600px;
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* T√πy ch·ªânh m√†u s·∫Øc cho c√°c tr·∫°ng th√°i th√πng r√°c */
        .bin-marker-full {
            background-color: #ef4444; /* M√†u ƒë·ªè cho th√πng ƒë·∫ßy */
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        .bin-marker-normal {
            background-color: #3b82f6; /* M√†u xanh cho th√πng b√¨nh th∆∞·ªùng */
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        .bin-marker-collected {
            background-color: #10b981; /* M√†u xanh l√° cho th√πng ƒë√£ thu gom */
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        /* Th√™m style m·ªõi cho th√πng r√°c h·ªèng */
        .bin-marker-broken {
            background-color: #4b5563; /* M√†u x√°m cho th√πng h·ªèng */
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        .truck-marker {
            background-color: #f59e0b; /* M√†u cam cho xe */
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
        }
        .incident-marker {
            background-color: #f59e0b; /* M√†u cam cho s·ª± c·ªë */
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 400px;
        }
    </style>
    <!-- Leaflet CSS v√† JS cho b·∫£n ƒë·ªì -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha2d3-QJz1SjR-W6i3Vd9H3j9r6a3C6D3B6S8C3F6F3B6S8C3" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha2d3-WB3A2P6k7J3L4J3Z3B6S8C3F6F3B6S8C3" crossorigin=""></script>
</head>
<body class="p-6">
    <div class="container mx-auto p-4 bg-gray-800 rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-center text-teal-400 mb-6">Ph·∫ßn m·ªÅm Qu·∫£n l√Ω Thu gom R√°c Th√¥ng minh</h1>
        
        <!-- Dashboard Th·ªëng k√™ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-6">
            <div class="bg-gray-900 p-3 md:p-4 rounded-lg shadow-md flex flex-col justify-center items-center">
                <p class="text-gray-400 text-xs md:text-sm">T·ªïng s·ªë th√πng r√°c</p>
                <p id="totalBins" class="text-xl md:text-2xl font-bold text-blue-400">0</p>
            </div>
            <div class="bg-gray-900 p-3 md:p-4 rounded-lg shadow-md flex flex-col justify-center items-center">
                <p class="text-gray-400 text-xs md:text-sm">S·ªë th√πng ƒë·∫ßy</p>
                <p id="fullBins" class="text-xl md:text-2xl font-bold text-red-400">0</p>
            </div>
            <div class="bg-gray-900 p-3 md:p-4 rounded-lg shadow-md flex flex-col justify-center items-center">
                <p class="text-gray-400 text-xs md:text-sm">T√¨nh tr·∫°ng xe</p>
                <p id="truckStatus" class="text-xl md:text-2xl font-bold text-green-400">ƒêang ch·ªù</p>
            </div>
            <div class="bg-gray-900 p-3 md:p-4 rounded-lg shadow-md flex flex-col justify-center items-center">
                <p class="text-gray-400 text-xs md:text-sm">L·ªô tr√¨nh</p>
                <p id="routeStatus" class="text-xl md:text-2xl font-bold text-yellow-400">Ch∆∞a c√≥</p>
            </div>
        </div>

        <!-- Khu v·ª±c B·∫£n ƒë·ªì v√† ƒêi·ªÅu khi·ªÉn -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- B·∫£n ƒë·ªì -->
            <div class="md:col-span-2">
                <div id="map"></div>
            </div>

            <!-- B·∫£ng ƒëi·ªÅu khi·ªÉn v√† Log -->
            <div class="md:col-span-1 flex flex-col bg-gray-900 p-4 rounded-lg shadow-md mt-6 md:mt-0">
                <h3 class="text-xl font-semibold mb-4">ƒêi·ªÅu khi·ªÉn & Gi√°m s√°t</h3>
                <div class="space-y-4 mb-4">
                    <button id="startBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out transform hover:scale-105">
                        B·∫Øt ƒë·∫ßu m√¥ ph·ªèng
                    </button>
                    <button id="optimizeBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out transform hover:scale-105" disabled>
                        T·ªëi ∆∞u h√≥a l·ªô tr√¨nh
                    </button>
                    <button id="reportIncidentBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out transform hover:scale-105" disabled>
                        B√°o c√°o s·ª± c·ªë
                    </button>
                    <!-- N√∫t m·ªõi ƒë·ªÉ b√°o c√°o th√πng r√°c b·ªã h·ªèng -->
                    <button id="reportBrokenBinBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out transform hover:scale-105" disabled>
                        B√°o c√°o th√πng h·ªèng
                    </button>
                </div>
                
                <h4 class="text-lg font-semibold mb-2">Nh·∫≠t k√Ω h·ªá th·ªëng:</h4>
                <div id="log" class="bg-gray-800 p-3 rounded-lg overflow-y-auto flex-grow h-48 border border-gray-700 text-gray-300 text-sm">
                    <!-- C√°c d√≤ng log s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Modal cho vi·ªác b√°o c√°o s·ª± c·ªë -->
    <div id="incidentModal" class="modal">
        <div class="modal-content">
            <h4 class="text-xl font-bold text-white mb-4">B√°o c√°o s·ª± c·ªë</h4>
            <p class="text-gray-300 mb-4">Vui l√≤ng nh·∫≠p l√Ω do s·ª± c·ªë:</p>
            <input type="text" id="incidentReasonInput" class="w-full p-2 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500 mb-4" placeholder="V√≠ d·ª•: t·∫Øc ƒë∆∞·ªùng, xe h·ªèng...">
            <div class="flex justify-end space-x-2">
                <button id="cancelIncidentBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                    H·ªßy
                </button>
                <button id="submitIncidentBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">
                    X√°c nh·∫≠n
                </button>
            </div>
        </div>
    </div>

    <!-- Modal m·ªõi cho vi·ªác b√°o c√°o th√πng r√°c h·ªèng -->
    <div id="brokenBinModal" class="modal">
        <div class="modal-content">
            <h4 class="text-xl font-bold text-white mb-4">B√°o c√°o th√πng r√°c h·ªèng</h4>
            <p class="text-gray-300 mb-4">Vui l√≤ng nh·∫≠p ID c·ªßa th√πng r√°c h·ªèng:</p>
            <input type="number" id="brokenBinIdInput" class="w-full p-2 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500 mb-4" placeholder="V√≠ d·ª•: 3">
            <div class="flex justify-end space-x-2">
                <button id="cancelBrokenBinBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                    H·ªßy
                </button>
                <button id="submitBrokenBinBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                    X√°c nh·∫≠n
                </button>
            </div>
        </div>
    </div>

    <script>
        // H·∫±ng s·ªë v√† c·∫•u h√¨nh
        const FULLNESS_THRESHOLD = 80; // Ng∆∞·ª°ng ƒë·∫ßy 80%
        const SIMULATION_INTERVAL = 3000; // C·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªói 3 gi√¢y

        // D·ªØ li·ªáu m√¥ ph·ªèng
        let bins = [
            { id: 1, lat: 21.028511, lng: 105.854134, fullness: 50, isCollected: false, isBroken: false, marker: null },
            { id: 2, lat: 21.031201, lng: 105.850422, fullness: 65, isCollected: false, isBroken: false, marker: null },
            { id: 3, lat: 21.034512, lng: 105.859678, fullness: 75, isCollected: false, isBroken: false, marker: null },
            { id: 4, lat: 21.025000, lng: 105.860100, fullness: 40, isCollected: false, isBroken: false, marker: null },
            { id: 5, lat: 21.022100, lng: 105.855000, fullness: 30, isCollected: false, isBroken: false, marker: null },
            { id: 6, lat: 21.029800, lng: 105.851000, fullness: 90, isCollected: false, isBroken: false, marker: null },
            { id: 7, lat: 21.033000, lng: 105.857000, fullness: 85, isCollected: false, isBroken: false, marker: null },
            { id: 8, lat: 21.027000, lng: 105.862000, fullness: 70, isCollected: false, isBroken: false, marker: null },
            { id: 9, lat: 21.030500, lng: 105.856500, fullness: 60, isCollected: false, isBroken: false, marker: null },
            { id: 10, lat: 21.026000, lng: 105.853000, fullness: 78, isCollected: false, isBroken: false, marker: null },
        ];
        
        let truck = { id: 'T-001', lat: 21.032, lng: 105.855, driver: 'Tr·∫ßn T√πng Em', marker: null, route: [] };
        let simulationInterval = null;
        let movementInterval = null;
        let isSimulating = false;
        let map;
        let routePolyline = null;
        let truckIcon;
        let incidentMarker = null;
        let routeTargetBins = []; 
        let currentTargetBinIndex = 0; 

        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
        const totalBinsEl = document.getElementById('totalBins');
        const fullBinsEl = document.getElementById('fullBins');
        const truckStatusEl = document.getElementById('truckStatus');
        const routeStatusEl = document.getElementById('routeStatus');
        const logEl = document.getElementById('log');
        const startBtn = document.getElementById('startBtn');
        const optimizeBtn = document.getElementById('optimizeBtn');
        const reportIncidentBtn = document.getElementById('reportIncidentBtn');
        const reportBrokenBinBtn = document.getElementById('reportBrokenBinBtn'); // N√∫t m·ªõi
        
        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM c·ªßa modal s·ª± c·ªë
        const incidentModal = document.getElementById('incidentModal');
        const incidentReasonInput = document.getElementById('incidentReasonInput');
        const submitIncidentBtn = document.getElementById('submitIncidentBtn');
        const cancelIncidentBtn = document.getElementById('cancelIncidentBtn');
        
        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM c·ªßa modal th√πng h·ªèng
        const brokenBinModal = document.getElementById('brokenBinModal');
        const brokenBinIdInput = document.getElementById('brokenBinIdInput');
        const submitBrokenBinBtn = document.getElementById('submitBrokenBinBtn');
        const cancelBrokenBinBtn = document.getElementById('cancelBrokenBinBtn');

        /**
         * @desc Ghi l·∫°i th√¥ng ƒëi·ªáp v√†o log box
         * @param {string} message - N·ªôi dung th√¥ng ƒëi·ªáp
         */
        const logMessage = (message) => {
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `<p class="text-xs text-gray-400">[${time}] ${message}</p>`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        /**
         * @desc Gi·∫£i m√£ chu·ªói polyline t·ª´ API OSRM
         * @param {string} str - Chu·ªói polyline ƒë√£ m√£ h√≥a
         * @returns {Array<Array<number>>} - M·∫£ng c√°c c·∫∑p t·ªça ƒë·ªô [lat, lng]
         */
        const decodePolyline = (str, precision = 5) => {
            let index = 0,
                lat = 0,
                lng = 0,
                coordinates = [],
                shift = 0,
                result = 0,
                byte = null,
                latitude_change,
                longitude_change;

            const factor = Math.pow(10, precision);

            while (index < str.length) {
                // Gi·∫£i m√£ vƒ© ƒë·ªô
                byte = null;
                shift = 0;
                result = 0;
                do {
                    byte = str.charCodeAt(index++) - 63;
                    result |= (byte & 0x1f) << shift;
                    shift += 5;
                } while (byte >= 0x20);

                latitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lat += latitude_change;

                // Gi·∫£i m√£ kinh ƒë·ªô
                shift = 0;
                result = 0;
                do {
                    byte = str.charCodeAt(index++) - 63;
                    result |= (byte & 0x1f) << shift;
                    shift += 5;
                } while (byte >= 0x20);

                longitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lng += longitude_change;

                coordinates.push([lat / factor, lng / factor]);
            }

            return coordinates;
        };
        
        /**
         * @desc T·∫°o icon t√πy ch·ªânh cho th√πng r√°c
         * @param {Object} bin - ƒê·ªëi t∆∞·ª£ng th√πng r√°c
         * @returns {L.DivIcon} - Icon Leaflet
         */
        const createBinIcon = (bin) => {
            let className = 'bin-marker-normal';
            let emoji = 'üóëÔ∏è';
            
            // ∆Øu ti√™n ki·ªÉm tra th√πng r√°c h·ªèng tr∆∞·ªõc
            if (bin.isBroken) {
                className = 'bin-marker-broken';
                emoji = '‚ùå';
            } else if (bin.fullness >= FULLNESS_THRESHOLD) {
                className = 'bin-marker-full';
            } else if (bin.fullness === 0) {
                className = 'bin-marker-collected';
                emoji = '‚ôªÔ∏è';
            }
            
            return L.divIcon({
                className: className,
                html: emoji,
                iconSize: [32, 32]
            });
        };

        /**
         * @desc Kh·ªüi t·∫°o b·∫£n ƒë·ªì Leaflet
         */
        const initMap = () => {
            logMessage("ƒêang kh·ªüi t·∫°o b·∫£n ƒë·ªì...");
            map = L.map('map').setView([truck.lat, truck.lng], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // T·∫°o icon cho xe
            truckIcon = L.divIcon({
                className: 'truck-marker',
                html: 'üöö',
                iconSize: [32, 32],
                iconAnchor: [16, 16],
            });

            // C·∫≠p nh·∫≠t b·∫£n ƒë·ªì l·∫ßn ƒë·∫ßu
            updateMap();
        };

        /**
         * @desc C·∫≠p nh·∫≠t v·ªã tr√≠ c·ªßa c√°c th√πng r√°c v√† xe tr√™n b·∫£n ƒë·ªì
         */
        const updateMap = () => {
            // C·∫≠p nh·∫≠t marker th√πng r√°c (t·∫°o m·ªõi n·∫øu ch∆∞a c√≥)
            bins.forEach(bin => {
                const icon = createBinIcon(bin);
                if (bin.marker) {
                    bin.marker.setIcon(icon);
                } else {
                    bin.marker = L.marker([bin.lat, bin.lng], { icon: icon }).addTo(map);
                }
                let popupContent = `<b>Th√πng r√°c ID: ${bin.id}</b><br>M·ª©c ƒë·∫ßy: ${bin.fullness}%`;
                if (bin.isBroken) {
                    popupContent += `<br><b>Tr·∫°ng th√°i: H·ªèng</b>`;
                }
                bin.marker.bindPopup(popupContent);
            });

            // C·∫≠p nh·∫≠t marker xe thu gom
            if (truck.marker) {
                truck.marker.setLatLng([truck.lat, truck.lng]);
            } else {
                truck.marker = L.marker([truck.lat, truck.lng], { icon: truckIcon }).addTo(map);
            }
            // C·∫≠p nh·∫≠t popup ƒë·ªÉ hi·ªÉn th·ªã t√™n t√†i x·∫ø
            truck.marker.bindPopup(`<b>Xe thu gom ID: ${truck.id}</b><br>T√†i x·∫ø: ${truck.driver}<br>Tr·∫°ng th√°i: ${truckStatusEl.innerText}`).openPopup();
            
            // C·∫≠p nh·∫≠t polyline l·ªô tr√¨nh
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }
            if (truck.route.length > 0) {
                routePolyline = L.polyline(truck.route, { color: '#3b82f6', weight: 4 }).addTo(map);
            }

            // C·∫≠p nh·∫≠t dashboard
            const fullBinsCount = bins.filter(b => b.fullness >= FULLNESS_THRESHOLD && !b.isBroken).length;
            totalBinsEl.innerText = bins.length;
            fullBinsEl.innerText = fullBinsCount;
        };

        /**
         * @desc M√¥ ph·ªèng vi·ªác thu th·∫≠p d·ªØ li·ªáu c·∫£m bi·∫øn
         */
        const updateSensorData = () => {
            if (!isSimulating) return;

            logMessage("ƒêang c·∫≠p nh·∫≠t d·ªØ li·ªáu c·∫£m bi·∫øn...");
            bins.forEach(bin => {
                // Ch·ªâ tƒÉng m·ª©c ƒë·∫ßy c·ªßa c√°c th√πng ch∆∞a ƒë∆∞·ª£c thu gom v√† kh√¥ng b·ªã h·ªèng
                if (!bin.isCollected && !bin.isBroken) {
                    bin.fullness += Math.floor(Math.random() * 10);
                    if (bin.fullness > 100) bin.fullness = 100;
                }
            });
            updateMap();
            logMessage("ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu c·∫£m bi·∫øn.");
        };

        /**
         * @desc T√¨m c√°c th√πng r√°c ƒë√£ ƒë·∫ßy v√† kh√¥ng b·ªã h·ªèng
         * @returns {Array} - M·∫£ng c√°c th√πng r√°c ƒë√£ ƒë·∫ßy
         */
        const findFullBins = () => {
            // Ch·ªâ quan t√¢m ƒë·∫øn c√°c th√πng r√°c ƒë·∫ßy, ch∆∞a ƒë∆∞·ª£c thu gom v√† kh√¥ng b·ªã h·ªèng
            const fullBins = bins.filter(bin => bin.fullness >= FULLNESS_THRESHOLD && !bin.isCollected && !bin.isBroken);
            if (fullBins.length > 0) {
                logMessage(`T√¨m th·∫•y ${fullBins.length} th√πng r√°c ƒë√£ ƒë·∫ßy v√† s·∫µn s√†ng thu gom.`);
            }
            return fullBins;
        };

        /**
         * @desc T√≠nh to√°n l·ªô tr√¨nh t·ªëi ∆∞u (s·ª≠ d·ª•ng OSRM)
         * @param {Array} binsToCollect - M·∫£ng c√°c th√πng r√°c c·∫ßn thu gom
         */
        const calculateOptimalRoute = async (binsToCollect) => {
            // D·ª´ng xe v√† x√≥a l·ªô tr√¨nh c≈© tr∆∞·ªõc khi t√≠nh l·ªô tr√¨nh m·ªõi
            if (movementInterval) clearInterval(movementInterval);
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }
            truck.route = [];

            if (binsToCollect.length === 0) {
                logMessage("Kh√¥ng c√≥ th√πng r√°c n√†o ƒë·∫ßy, kh√¥ng c·∫ßn t·∫°o l·ªô tr√¨nh.");
                updateMap();
                routeStatusEl.innerText = "ƒê√£ ho√†n th√†nh";
                return;
            }
            
            // Reset tr·∫°ng th√°i "ƒë√£ thu gom" c·ªßa t·∫•t c·∫£ c√°c th√πng r√°c tr∆∞·ªõc khi t·∫°o l·ªô tr√¨nh m·ªõi
            bins.forEach(bin => bin.isCollected = false);
            
            logMessage("ƒêang t√≠nh to√°n l·ªô tr√¨nh t·ªëi ∆∞u (s·ª≠ d·ª•ng OSRM)...");
            
            // X√¢y d·ª±ng chu·ªói t·ªça ƒë·ªô cho API OSRM
            // B·∫Øt ƒë·∫ßu t·ª´ v·ªã tr√≠ xe v√† ƒëi qua c√°c th√πng r√°c
            const waypoints = [
                [truck.lng, truck.lat],
                ...binsToCollect.map(bin => [bin.lng, bin.lat])
            ].join(';');

            const apiUrl = `https://router.project-osrm.org/route/v1/driving/${waypoints}?overview=full&geometries=polyline`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.code === 'Ok') {
                    const polyline = data.routes[0].geometry;
                    truck.route = decodePolyline(polyline);
                    
                    // L·∫•y danh s√°ch th√πng r√°c ƒë√£ ƒë∆∞·ª£c s·∫Øp x·∫øp theo l·ªô tr√¨nh t·ªëi ∆∞u t·ª´ waypoints c·ªßa OSRM
                    routeTargetBins = [];
                    // B·ªè qua waypoint ƒë·∫ßu ti√™n v√¨ n√≥ l√† v·ªã tr√≠ xu·∫•t ph√°t c·ªßa xe
                    for(let i = 1; i < data.waypoints.length; i++) {
                        const waypoint = data.waypoints[i];
                        const bin = bins.find(b => 
                            Math.abs(b.lat - waypoint.location[1]) < 0.0001 &&
                            Math.abs(b.lng - waypoint.location[0]) < 0.0001
                        );
                        if (bin) {
                            routeTargetBins.push(bin);
                        }
                    }
                    currentTargetBinIndex = 0;

                    logMessage(`L·ªô tr√¨nh m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o v·ªõi ${routeTargetBins.length} ƒëi·ªÉm d·ª´ng.`);
                    routeStatusEl.innerText = "ƒê√£ c√≥ l·ªô tr√¨nh";
                    truckStatusEl.innerText = "ƒêang di chuy·ªÉn";
                    
                    // B·∫Øt ƒë·∫ßu m√¥ ph·ªèng vi·ªác xe di chuy·ªÉn
                    simulateTruckMovement();
                } else {
                    logMessage(`L·ªói khi g·ªçi API OSRM: ${data.message}`);
                    routeStatusEl.innerText = "L·ªói";
                }
            } catch (error) {
                logMessage(`L·ªói m·∫°ng khi g·ªçi API OSRM: ${error.message}`);
                routeStatusEl.innerText = "L·ªói";
            }
        };

        /**
         * @desc M√¥ ph·ªèng vi·ªác xe di chuy·ªÉn theo l·ªô tr√¨nh ƒë√£ t√≠nh to√°n
         */
        const simulateTruckMovement = () => {
            if (movementInterval) clearInterval(movementInterval);
            if (truck.route.length === 0) {
                truckStatusEl.innerText = "ƒê√£ ho√†n th√†nh";
                return;
            }

            let currentRouteIndex = 0;
            movementInterval = setInterval(() => {
                if (currentRouteIndex < truck.route.length) {
                    const [lat, lng] = truck.route[currentRouteIndex];
                    truck.lat = lat;
                    truck.lng = lng;

                    // Ki·ªÉm tra xem xe ƒë√£ ƒë·∫øn th√πng r√°c m·ª•c ti√™u ch∆∞a
                    if (currentTargetBinIndex < routeTargetBins.length) {
                        const currentTargetBin = routeTargetBins[currentTargetBinIndex];
                        const dist = Math.sqrt(
                            Math.pow(currentTargetBin.lat - lat, 2) + 
                            Math.pow(currentTargetBin.lng - lng, 2)
                        );
                        
                        const tolerance = 0.0005; 

                        if (dist < tolerance) {
                            // Xe ƒë√£ ƒë·∫øn th√πng r√°c, th·ª±c hi·ªán thu gom
                            const originalBin = bins.find(b => b.id === currentTargetBin.id);
                            if (originalBin) {
                                originalBin.fullness = 0;
                                originalBin.isCollected = true;
                                logMessage(`ƒê√£ thu gom r√°c t·∫°i th√πng ID: ${originalBin.id}. M·ª©c ƒë·∫ßy ƒë∆∞·ª£c reset.`);
                            }
                            
                            // Chuy·ªÉn sang th√πng r√°c m·ª•c ti√™u ti·∫øp theo
                            currentTargetBinIndex++;
                        }
                    }
                    
                    currentRouteIndex++;
                    updateMap();

                } else {
                    // ƒê√£ ƒëi h·∫øt l·ªô tr√¨nh
                    clearInterval(movementInterval);
                    logMessage("Xe ƒë√£ ho√†n th√†nh l·ªô tr√¨nh.");
                    truckStatusEl.innerText = "ƒê√£ ho√†n th√†nh";
                    routeStatusEl.innerText = "Ho√†n th√†nh";
                    // X√≥a polyline sau khi ho√†n th√†nh
                    if (routePolyline) {
                        map.removeLayer(routePolyline);
                        routePolyline = null;
                    }
                }
            }, 500);
        };
        
        /**
         * @desc B√°o c√°o v√† x·ª≠ l√Ω s·ª± c·ªë t·ª´ modal
         * @param {string} reason - L√Ω do s·ª± c·ªë
         */
        const handleIncidentReport = (reason) => {
            // D·ª´ng xe v√† x√≥a l·ªô tr√¨nh c≈©
            if (movementInterval) clearInterval(movementInterval);
            truck.route = []; // X√≥a l·ªô tr√¨nh hi·ªán t·∫°i
            logMessage(`S·ª± c·ªë ƒë√£ ƒë∆∞·ª£c b√°o c√°o v·ªõi l√Ω do: "${reason}". Xe ƒëang t·∫°m d·ª´ng.`);
            truckStatusEl.innerText = "G·∫∑p s·ª± c·ªë";
            routeStatusEl.innerText = "ƒêang t√≠nh l·∫°i l·ªô tr√¨nh";
            
            // ƒê·∫∑t m·ªôt marker s·ª± c·ªë
            if (incidentMarker) {
                map.removeLayer(incidentMarker);
            }
            const incidentIcon = L.divIcon({
                className: 'incident-marker',
                html: '‚ö†Ô∏è',
                iconSize: [32, 32]
            });
            
            // V·ªã tr√≠ s·ª± c·ªë gi·∫£ l·∫≠p g·∫ßn v·ªã tr√≠ xe hi·ªán t·∫°i
            const incidentLat = truck.lat + (Math.random() - 0.5) * 0.005;
            const incidentLng = truck.lng + (Math.random() - 0.5) * 0.005;
            incidentMarker = L.marker([incidentLat, incidentLng], { icon: incidentIcon }).addTo(map);
            // C·∫≠p nh·∫≠t popup ƒë·ªÉ hi·ªÉn th·ªã l√Ω do s·ª± c·ªë
            incidentMarker.bindPopup(`<b>S·ª± c·ªë giao th√¥ng!</b><br>L√Ω do: ${reason}`).openPopup();
            
            // T√≠nh l·∫°i l·ªô tr√¨nh sau m·ªôt ch√∫t
            setTimeout(() => {
                logMessage("ƒêang t√≠nh to√°n l·∫°i l·ªô tr√¨nh m·ªõi...");
                const remainingBins = bins.filter(bin => bin.fullness >= FULLNESS_THRESHOLD && !bin.isCollected && !bin.isBroken);
                if (remainingBins.length > 0) {
                    calculateOptimalRoute(remainingBins);
                } else {
                    logMessage("Kh√¥ng c√≤n th√πng r√°c c·∫ßn thu gom. L·ªô tr√¨nh m·ªõi kh√¥ng c·∫ßn thi·∫øt.");
                    truckStatusEl.innerText = "ƒê√£ ho√†n th√†nh";
                    routeStatusEl.innerText = "Ho√†n th√†nh";
                }
            }, 3000);
        };
        
        /**
         * @desc X·ª≠ l√Ω khi b√°o c√°o th√πng r√°c h·ªèng
         * @param {number} binId - ID c·ªßa th√πng r√°c h·ªèng
         */
        const handleBrokenBinReport = (binId) => {
            const bin = bins.find(b => b.id === binId);
            if (bin) {
                bin.isBroken = true;
                logMessage(`Th√πng r√°c ID: ${binId} ƒë√£ ƒë∆∞·ª£c b√°o c√°o l√† h·ªèng.`);
                
                // C·∫≠p nh·∫≠t b·∫£n ƒë·ªì ngay l·∫≠p t·ª©c ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i m·ªõi
                updateMap();
                
                // N·∫øu xe ƒëang tr√™n l·ªô tr√¨nh, t√≠nh l·∫°i l·ªô tr√¨nh ƒë·ªÉ b·ªè qua th√πng r√°c h·ªèng
                if (isSimulating && routeStatusEl.innerText === "ƒê√£ c√≥ l·ªô tr√¨nh") {
                    logMessage("Ph√°t hi·ªán th√πng h·ªèng trong l·ªô tr√¨nh. ƒêang t√≠nh to√°n l·∫°i l·ªô tr√¨nh.");
                    const remainingBins = bins.filter(b => b.fullness >= FULLNESS_THRESHOLD && !b.isCollected && !b.isBroken);
                    calculateOptimalRoute(remainingBins);
                }
            } else {
                logMessage(`Kh√¥ng t√¨m th·∫•y th√πng r√°c c√≥ ID: ${binId}.`);
            }
        };


        // X·ª≠ l√Ω s·ª± ki·ªán n√∫t
        startBtn.addEventListener('click', () => {
            if (!isSimulating) {
                isSimulating = true;
                simulationInterval = setInterval(updateSensorData, SIMULATION_INTERVAL);
                startBtn.innerText = "D·ª´ng m√¥ ph·ªèng";
                startBtn.classList.remove('bg-blue-600');
                startBtn.classList.add('bg-red-600');
                optimizeBtn.disabled = false;
                reportIncidentBtn.disabled = false;
                reportBrokenBinBtn.disabled = false;
                logMessage("B·∫Øt ƒë·∫ßu m√¥ ph·ªèng thu th·∫≠p d·ªØ li·ªáu.");
                truckStatusEl.innerText = "ƒêang ch·ªù";
            } else {
                isSimulating = false;
                clearInterval(simulationInterval);
                if (movementInterval) clearInterval(movementInterval);
                startBtn.innerText = "B·∫Øt ƒë·∫ßu m√¥ ph·ªèng";
                startBtn.classList.remove('bg-red-600');
                startBtn.classList.add('bg-blue-600');
                optimizeBtn.disabled = true;
                reportIncidentBtn.disabled = true;
                reportBrokenBinBtn.disabled = true;
                logMessage("D·ª´ng m√¥ ph·ªèng.");
            }
        });

        optimizeBtn.addEventListener('click', () => {
            logMessage("Ng∆∞·ªùi qu·∫£n l√Ω y√™u c·∫ßu t·ªëi ∆∞u h√≥a l·ªô tr√¨nh.");
            const fullBins = findFullBins();
            calculateOptimalRoute(fullBins);
        });
        
        // C·∫≠p nh·∫≠t x·ª≠ l√Ω s·ª± ki·ªán b√°o c√°o s·ª± c·ªë ƒë·ªÉ hi·ªÉn th·ªã modal
        reportIncidentBtn.addEventListener('click', () => {
            incidentModal.style.display = 'flex';
        });

        submitIncidentBtn.addEventListener('click', () => {
            const reason = incidentReasonInput.value;
            if (reason) {
                handleIncidentReport(reason);
            } else {
                logMessage("L√Ω do kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
            }
            incidentReasonInput.value = '';
            incidentModal.style.display = 'none';
        });

        cancelIncidentBtn.addEventListener('click', () => {
            incidentReasonInput.value = '';
            incidentModal.style.display = 'none';
            logMessage("H·ªßy b√°o c√°o s·ª± c·ªë.");
        });

        // X·ª≠ l√Ω s·ª± ki·ªán cho n√∫t v√† modal th√πng r√°c h·ªèng
        reportBrokenBinBtn.addEventListener('click', () => {
            brokenBinModal.style.display = 'flex';
        });

        submitBrokenBinBtn.addEventListener('click', () => {
            const binId = parseInt(brokenBinIdInput.value, 10);
            if (!isNaN(binId)) {
                handleBrokenBinReport(binId);
            } else {
                logMessage("ID kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p m·ªôt s·ªë.");
            }
            brokenBinIdInput.value = '';
            brokenBinModal.style.display = 'none';
        });

        cancelBrokenBinBtn.addEventListener('click', () => {
            brokenBinIdInput.value = '';
            brokenBinModal.style.display = 'none';
            logMessage("H·ªßy b√°o c√°o th√πng r√°c h·ªèng.");
        });

        // Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng khi trang ƒë∆∞·ª£c t·∫£i
        window.onload = function() {
            logMessage("Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi demo. H√£y nh·∫•n 'B·∫Øt ƒë·∫ßu m√¥ ph·ªèng' ƒë·ªÉ kh·ªüi ƒë·ªông h·ªá th·ªëng.");
            initMap();
        };
    </script>
</body>
</html>
