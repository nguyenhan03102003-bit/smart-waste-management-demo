<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Phần mềm Quản lý Rác Thông minh</title>
    <!-- Tailwind CSS CDN để tạo giao diện đẹp và responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Màu nền tối */
            color: #e2e8f0; /* Màu chữ sáng */
        }
        #map {
            height: 600px;
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Tùy chỉnh màu sắc cho các trạng thái thùng rác */
        .bin-marker-full {
            background-color: #ef4444; /* Màu đỏ cho thùng đầy */
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        .bin-marker-normal {
            background-color: #3b82f6; /* Màu xanh cho thùng bình thường */
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        .bin-marker-collected {
            background-color: #10b981; /* Màu xanh lá cho thùng đã thu gom */
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        /* Thêm style mới cho thùng rác hỏng */
        .bin-marker-broken {
            background-color: #4b5563; /* Màu xám cho thùng hỏng */
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        .truck-marker {
            background-color: #f59e0b; /* Màu cam cho xe */
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
        }
        .incident-marker {
            background-color: #f59e0b; /* Màu cam cho sự cố */
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 400px;
        }
    </style>
    <!-- Leaflet CSS và JS cho bản đồ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha2d3-QJz1SjR-W6i3Vd9H3j9r6a3C6D3B6S8C3F6F3B6S8C3" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha2d3-WB3A2P6k7J3L4J3Z3B6S8C3F6F3B6S8C3" crossorigin=""></script>
</head>
<body class="p-6">
    <div class="container mx-auto p-4 bg-gray-800 rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-center text-teal-400 mb-6">Phần mềm Quản lý Thu gom Rác Thông minh</h1>
        
        <!-- Dashboard Thống kê -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-6">
            <div class="bg-gray-900 p-3 md:p-4 rounded-lg shadow-md flex flex-col justify-center items-center">
                <p class="text-gray-400 text-xs md:text-sm">Tổng số thùng rác</p>
                <p id="totalBins" class="text-xl md:text-2xl font-bold text-blue-400">0</p>
            </div>
            <div class="bg-gray-900 p-3 md:p-4 rounded-lg shadow-md flex flex-col justify-center items-center">
                <p class="text-gray-400 text-xs md:text-sm">Số thùng đầy</p>
                <p id="fullBins" class="text-xl md:text-2xl font-bold text-red-400">0</p>
            </div>
            <div class="bg-gray-900 p-3 md:p-4 rounded-lg shadow-md flex flex-col justify-center items-center">
                <p class="text-gray-400 text-xs md:text-sm">Tình trạng xe</p>
                <p id="truckStatus" class="text-xl md:text-2xl font-bold text-green-400">Đang chờ</p>
            </div>
            <div class="bg-gray-900 p-3 md:p-4 rounded-lg shadow-md flex flex-col justify-center items-center">
                <p class="text-gray-400 text-xs md:text-sm">Lộ trình</p>
                <p id="routeStatus" class="text-xl md:text-2xl font-bold text-yellow-400">Chưa có</p>
            </div>
        </div>

        <!-- Khu vực Bản đồ và Điều khiển -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Bản đồ -->
            <div class="md:col-span-2">
                <div id="map"></div>
            </div>

            <!-- Bảng điều khiển và Log -->
            <div class="md:col-span-1 flex flex-col bg-gray-900 p-4 rounded-lg shadow-md mt-6 md:mt-0">
                <h3 class="text-xl font-semibold mb-4">Điều khiển & Giám sát</h3>
                <div class="space-y-4 mb-4">
                    <button id="startBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out transform hover:scale-105">
                        Bắt đầu mô phỏng
                    </button>
                    <button id="optimizeBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out transform hover:scale-105" disabled>
                        Tối ưu hóa lộ trình
                    </button>
                    <button id="reportIncidentBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out transform hover:scale-105" disabled>
                        Báo cáo sự cố
                    </button>
                    <!-- Nút mới để báo cáo thùng rác bị hỏng -->
                    <button id="reportBrokenBinBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out transform hover:scale-105" disabled>
                        Báo cáo thùng hỏng
                    </button>
                </div>
                
                <h4 class="text-lg font-semibold mb-2">Nhật ký hệ thống:</h4>
                <div id="log" class="bg-gray-800 p-3 rounded-lg overflow-y-auto flex-grow h-48 border border-gray-700 text-gray-300 text-sm">
                    <!-- Các dòng log sẽ xuất hiện ở đây -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Modal cho việc báo cáo sự cố -->
    <div id="incidentModal" class="modal">
        <div class="modal-content">
            <h4 class="text-xl font-bold text-white mb-4">Báo cáo sự cố</h4>
            <p class="text-gray-300 mb-4">Vui lòng nhập lý do sự cố:</p>
            <input type="text" id="incidentReasonInput" class="w-full p-2 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500 mb-4" placeholder="Ví dụ: tắc đường, xe hỏng...">
            <div class="flex justify-end space-x-2">
                <button id="cancelIncidentBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                    Hủy
                </button>
                <button id="submitIncidentBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">
                    Xác nhận
                </button>
            </div>
        </div>
    </div>

    <!-- Modal mới cho việc báo cáo thùng rác hỏng -->
    <div id="brokenBinModal" class="modal">
        <div class="modal-content">
            <h4 class="text-xl font-bold text-white mb-4">Báo cáo thùng rác hỏng</h4>
            <p class="text-gray-300 mb-4">Vui lòng nhập ID của thùng rác hỏng:</p>
            <input type="number" id="brokenBinIdInput" class="w-full p-2 rounded-md bg-gray-700 text-white border border-gray-600 focus:outline-none focus:border-blue-500 mb-4" placeholder="Ví dụ: 3">
            <div class="flex justify-end space-x-2">
                <button id="cancelBrokenBinBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                    Hủy
                </button>
                <button id="submitBrokenBinBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                    Xác nhận
                </button>
            </div>
        </div>
    </div>

    <script>
        // Hằng số và cấu hình
        const FULLNESS_THRESHOLD = 80; // Ngưỡng đầy 80%
        const SIMULATION_INTERVAL = 3000; // Cập nhật dữ liệu mỗi 3 giây

        // Dữ liệu mô phỏng
        let bins = [
            { id: 1, lat: 21.028511, lng: 105.854134, fullness: 50, isCollected: false, isBroken: false, marker: null },
            { id: 2, lat: 21.031201, lng: 105.850422, fullness: 65, isCollected: false, isBroken: false, marker: null },
            { id: 3, lat: 21.034512, lng: 105.859678, fullness: 75, isCollected: false, isBroken: false, marker: null },
            { id: 4, lat: 21.025000, lng: 105.860100, fullness: 40, isCollected: false, isBroken: false, marker: null },
            { id: 5, lat: 21.022100, lng: 105.855000, fullness: 30, isCollected: false, isBroken: false, marker: null },
            { id: 6, lat: 21.029800, lng: 105.851000, fullness: 90, isCollected: false, isBroken: false, marker: null },
            { id: 7, lat: 21.033000, lng: 105.857000, fullness: 85, isCollected: false, isBroken: false, marker: null },
            { id: 8, lat: 21.027000, lng: 105.862000, fullness: 70, isCollected: false, isBroken: false, marker: null },
            { id: 9, lat: 21.030500, lng: 105.856500, fullness: 60, isCollected: false, isBroken: false, marker: null },
            { id: 10, lat: 21.026000, lng: 105.853000, fullness: 78, isCollected: false, isBroken: false, marker: null },
        ];
        
        let truck = { id: 'T-001', lat: 21.032, lng: 105.855, driver: 'Trần Tùng Em', marker: null, route: [] };
        let simulationInterval = null;
        let movementInterval = null;
        let isSimulating = false;
        let map;
        let routePolyline = null;
        let truckIcon;
        let incidentMarker = null;
        let routeTargetBins = []; 
        let currentTargetBinIndex = 0; 

        // Lấy các phần tử DOM
        const totalBinsEl = document.getElementById('totalBins');
        const fullBinsEl = document.getElementById('fullBins');
        const truckStatusEl = document.getElementById('truckStatus');
        const routeStatusEl = document.getElementById('routeStatus');
        const logEl = document.getElementById('log');
        const startBtn = document.getElementById('startBtn');
        const optimizeBtn = document.getElementById('optimizeBtn');
        const reportIncidentBtn = document.getElementById('reportIncidentBtn');
        const reportBrokenBinBtn = document.getElementById('reportBrokenBinBtn'); // Nút mới
        
        // Lấy các phần tử DOM của modal sự cố
        const incidentModal = document.getElementById('incidentModal');
        const incidentReasonInput = document.getElementById('incidentReasonInput');
        const submitIncidentBtn = document.getElementById('submitIncidentBtn');
        const cancelIncidentBtn = document.getElementById('cancelIncidentBtn');
        
        // Lấy các phần tử DOM của modal thùng hỏng
        const brokenBinModal = document.getElementById('brokenBinModal');
        const brokenBinIdInput = document.getElementById('brokenBinIdInput');
        const submitBrokenBinBtn = document.getElementById('submitBrokenBinBtn');
        const cancelBrokenBinBtn = document.getElementById('cancelBrokenBinBtn');

        /**
         * @desc Ghi lại thông điệp vào log box
         * @param {string} message - Nội dung thông điệp
         */
        const logMessage = (message) => {
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `<p class="text-xs text-gray-400">[${time}] ${message}</p>`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        /**
         * @desc Giải mã chuỗi polyline từ API OSRM
         * @param {string} str - Chuỗi polyline đã mã hóa
         * @returns {Array<Array<number>>} - Mảng các cặp tọa độ [lat, lng]
         */
        const decodePolyline = (str, precision = 5) => {
            let index = 0,
                lat = 0,
                lng = 0,
                coordinates = [],
                shift = 0,
                result = 0,
                byte = null,
                latitude_change,
                longitude_change;

            const factor = Math.pow(10, precision);

            while (index < str.length) {
                // Giải mã vĩ độ
                byte = null;
                shift = 0;
                result = 0;
                do {
                    byte = str.charCodeAt(index++) - 63;
                    result |= (byte & 0x1f) << shift;
                    shift += 5;
                } while (byte >= 0x20);

                latitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lat += latitude_change;

                // Giải mã kinh độ
                shift = 0;
                result = 0;
                do {
                    byte = str.charCodeAt(index++) - 63;
                    result |= (byte & 0x1f) << shift;
                    shift += 5;
                } while (byte >= 0x20);

                longitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lng += longitude_change;

                coordinates.push([lat / factor, lng / factor]);
            }

            return coordinates;
        };
        
        /**
         * @desc Tạo icon tùy chỉnh cho thùng rác
         * @param {Object} bin - Đối tượng thùng rác
         * @returns {L.DivIcon} - Icon Leaflet
         */
        const createBinIcon = (bin) => {
            let className = 'bin-marker-normal';
            let emoji = '🗑️';
            
            // Ưu tiên kiểm tra thùng rác hỏng trước
            if (bin.isBroken) {
                className = 'bin-marker-broken';
                emoji = '❌';
            } else if (bin.fullness >= FULLNESS_THRESHOLD) {
                className = 'bin-marker-full';
            } else if (bin.fullness === 0) {
                className = 'bin-marker-collected';
                emoji = '♻️';
            }
            
            return L.divIcon({
                className: className,
                html: emoji,
                iconSize: [32, 32]
            });
        };

        /**
         * @desc Khởi tạo bản đồ Leaflet
         */
        const initMap = () => {
            logMessage("Đang khởi tạo bản đồ...");
            map = L.map('map').setView([truck.lat, truck.lng], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // Tạo icon cho xe
            truckIcon = L.divIcon({
                className: 'truck-marker',
                html: '🚚',
                iconSize: [32, 32],
                iconAnchor: [16, 16],
            });

            // Cập nhật bản đồ lần đầu
            updateMap();
        };

        /**
         * @desc Cập nhật vị trí của các thùng rác và xe trên bản đồ
         */
        const updateMap = () => {
            // Cập nhật marker thùng rác (tạo mới nếu chưa có)
            bins.forEach(bin => {
                const icon = createBinIcon(bin);
                if (bin.marker) {
                    bin.marker.setIcon(icon);
                } else {
                    bin.marker = L.marker([bin.lat, bin.lng], { icon: icon }).addTo(map);
                }
                let popupContent = `<b>Thùng rác ID: ${bin.id}</b><br>Mức đầy: ${bin.fullness}%`;
                if (bin.isBroken) {
                    popupContent += `<br><b>Trạng thái: Hỏng</b>`;
                }
                bin.marker.bindPopup(popupContent);
            });

            // Cập nhật marker xe thu gom
            if (truck.marker) {
                truck.marker.setLatLng([truck.lat, truck.lng]);
            } else {
                truck.marker = L.marker([truck.lat, truck.lng], { icon: truckIcon }).addTo(map);
            }
            // Cập nhật popup để hiển thị tên tài xế
            truck.marker.bindPopup(`<b>Xe thu gom ID: ${truck.id}</b><br>Tài xế: ${truck.driver}<br>Trạng thái: ${truckStatusEl.innerText}`).openPopup();
            
            // Cập nhật polyline lộ trình
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }
            if (truck.route.length > 0) {
                routePolyline = L.polyline(truck.route, { color: '#3b82f6', weight: 4 }).addTo(map);
            }

            // Cập nhật dashboard
            const fullBinsCount = bins.filter(b => b.fullness >= FULLNESS_THRESHOLD && !b.isBroken).length;
            totalBinsEl.innerText = bins.length;
            fullBinsEl.innerText = fullBinsCount;
        };

        /**
         * @desc Mô phỏng việc thu thập dữ liệu cảm biến
         */
        const updateSensorData = () => {
            if (!isSimulating) return;

            logMessage("Đang cập nhật dữ liệu cảm biến...");
            bins.forEach(bin => {
                // Chỉ tăng mức đầy của các thùng chưa được thu gom và không bị hỏng
                if (!bin.isCollected && !bin.isBroken) {
                    bin.fullness += Math.floor(Math.random() * 10);
                    if (bin.fullness > 100) bin.fullness = 100;
                }
            });
            updateMap();
            logMessage("Đã cập nhật dữ liệu cảm biến.");
        };

        /**
         * @desc Tìm các thùng rác đã đầy và không bị hỏng
         * @returns {Array} - Mảng các thùng rác đã đầy
         */
        const findFullBins = () => {
            // Chỉ quan tâm đến các thùng rác đầy, chưa được thu gom và không bị hỏng
            const fullBins = bins.filter(bin => bin.fullness >= FULLNESS_THRESHOLD && !bin.isCollected && !bin.isBroken);
            if (fullBins.length > 0) {
                logMessage(`Tìm thấy ${fullBins.length} thùng rác đã đầy và sẵn sàng thu gom.`);
            }
            return fullBins;
        };

        /**
         * @desc Tính toán lộ trình tối ưu (sử dụng OSRM)
         * @param {Array} binsToCollect - Mảng các thùng rác cần thu gom
         */
        const calculateOptimalRoute = async (binsToCollect) => {
            // Dừng xe và xóa lộ trình cũ trước khi tính lộ trình mới
            if (movementInterval) clearInterval(movementInterval);
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }
            truck.route = [];

            if (binsToCollect.length === 0) {
                logMessage("Không có thùng rác nào đầy, không cần tạo lộ trình.");
                updateMap();
                routeStatusEl.innerText = "Đã hoàn thành";
                return;
            }
            
            // Reset trạng thái "đã thu gom" của tất cả các thùng rác trước khi tạo lộ trình mới
            bins.forEach(bin => bin.isCollected = false);
            
            logMessage("Đang tính toán lộ trình tối ưu (sử dụng OSRM)...");
            
            // Xây dựng chuỗi tọa độ cho API OSRM
            // Bắt đầu từ vị trí xe và đi qua các thùng rác
            const waypoints = [
                [truck.lng, truck.lat],
                ...binsToCollect.map(bin => [bin.lng, bin.lat])
            ].join(';');

            const apiUrl = `https://router.project-osrm.org/route/v1/driving/${waypoints}?overview=full&geometries=polyline`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.code === 'Ok') {
                    const polyline = data.routes[0].geometry;
                    truck.route = decodePolyline(polyline);
                    
                    // Lấy danh sách thùng rác đã được sắp xếp theo lộ trình tối ưu từ waypoints của OSRM
                    routeTargetBins = [];
                    // Bỏ qua waypoint đầu tiên vì nó là vị trí xuất phát của xe
                    for(let i = 1; i < data.waypoints.length; i++) {
                        const waypoint = data.waypoints[i];
                        const bin = bins.find(b => 
                            Math.abs(b.lat - waypoint.location[1]) < 0.0001 &&
                            Math.abs(b.lng - waypoint.location[0]) < 0.0001
                        );
                        if (bin) {
                            routeTargetBins.push(bin);
                        }
                    }
                    currentTargetBinIndex = 0;

                    logMessage(`Lộ trình mới đã được tạo với ${routeTargetBins.length} điểm dừng.`);
                    routeStatusEl.innerText = "Đã có lộ trình";
                    truckStatusEl.innerText = "Đang di chuyển";
                    
                    // Bắt đầu mô phỏng việc xe di chuyển
                    simulateTruckMovement();
                } else {
                    logMessage(`Lỗi khi gọi API OSRM: ${data.message}`);
                    routeStatusEl.innerText = "Lỗi";
                }
            } catch (error) {
                logMessage(`Lỗi mạng khi gọi API OSRM: ${error.message}`);
                routeStatusEl.innerText = "Lỗi";
            }
        };

        /**
         * @desc Mô phỏng việc xe di chuyển theo lộ trình đã tính toán
         */
        const simulateTruckMovement = () => {
            if (movementInterval) clearInterval(movementInterval);
            if (truck.route.length === 0) {
                truckStatusEl.innerText = "Đã hoàn thành";
                return;
            }

            let currentRouteIndex = 0;
            movementInterval = setInterval(() => {
                if (currentRouteIndex < truck.route.length) {
                    const [lat, lng] = truck.route[currentRouteIndex];
                    truck.lat = lat;
                    truck.lng = lng;

                    // Kiểm tra xem xe đã đến thùng rác mục tiêu chưa
                    if (currentTargetBinIndex < routeTargetBins.length) {
                        const currentTargetBin = routeTargetBins[currentTargetBinIndex];
                        const dist = Math.sqrt(
                            Math.pow(currentTargetBin.lat - lat, 2) + 
                            Math.pow(currentTargetBin.lng - lng, 2)
                        );
                        
                        const tolerance = 0.0005; 

                        if (dist < tolerance) {
                            // Xe đã đến thùng rác, thực hiện thu gom
                            const originalBin = bins.find(b => b.id === currentTargetBin.id);
                            if (originalBin) {
                                originalBin.fullness = 0;
                                originalBin.isCollected = true;
                                logMessage(`Đã thu gom rác tại thùng ID: ${originalBin.id}. Mức đầy được reset.`);
                            }
                            
                            // Chuyển sang thùng rác mục tiêu tiếp theo
                            currentTargetBinIndex++;
                        }
                    }
                    
                    currentRouteIndex++;
                    updateMap();

                } else {
                    // Đã đi hết lộ trình
                    clearInterval(movementInterval);
                    logMessage("Xe đã hoàn thành lộ trình.");
                    truckStatusEl.innerText = "Đã hoàn thành";
                    routeStatusEl.innerText = "Hoàn thành";
                    // Xóa polyline sau khi hoàn thành
                    if (routePolyline) {
                        map.removeLayer(routePolyline);
                        routePolyline = null;
                    }
                }
            }, 500);
        };
        
        /**
         * @desc Báo cáo và xử lý sự cố từ modal
         * @param {string} reason - Lý do sự cố
         */
        const handleIncidentReport = (reason) => {
            // Dừng xe và xóa lộ trình cũ
            if (movementInterval) clearInterval(movementInterval);
            truck.route = []; // Xóa lộ trình hiện tại
            logMessage(`Sự cố đã được báo cáo với lý do: "${reason}". Xe đang tạm dừng.`);
            truckStatusEl.innerText = "Gặp sự cố";
            routeStatusEl.innerText = "Đang tính lại lộ trình";
            
            // Đặt một marker sự cố
            if (incidentMarker) {
                map.removeLayer(incidentMarker);
            }
            const incidentIcon = L.divIcon({
                className: 'incident-marker',
                html: '⚠️',
                iconSize: [32, 32]
            });
            
            // Vị trí sự cố giả lập gần vị trí xe hiện tại
            const incidentLat = truck.lat + (Math.random() - 0.5) * 0.005;
            const incidentLng = truck.lng + (Math.random() - 0.5) * 0.005;
            incidentMarker = L.marker([incidentLat, incidentLng], { icon: incidentIcon }).addTo(map);
            // Cập nhật popup để hiển thị lý do sự cố
            incidentMarker.bindPopup(`<b>Sự cố giao thông!</b><br>Lý do: ${reason}`).openPopup();
            
            // Tính lại lộ trình sau một chút
            setTimeout(() => {
                logMessage("Đang tính toán lại lộ trình mới...");
                const remainingBins = bins.filter(bin => bin.fullness >= FULLNESS_THRESHOLD && !bin.isCollected && !bin.isBroken);
                if (remainingBins.length > 0) {
                    calculateOptimalRoute(remainingBins);
                } else {
                    logMessage("Không còn thùng rác cần thu gom. Lộ trình mới không cần thiết.");
                    truckStatusEl.innerText = "Đã hoàn thành";
                    routeStatusEl.innerText = "Hoàn thành";
                }
            }, 3000);
        };
        
        /**
         * @desc Xử lý khi báo cáo thùng rác hỏng
         * @param {number} binId - ID của thùng rác hỏng
         */
        const handleBrokenBinReport = (binId) => {
            const bin = bins.find(b => b.id === binId);
            if (bin) {
                bin.isBroken = true;
                logMessage(`Thùng rác ID: ${binId} đã được báo cáo là hỏng.`);
                
                // Cập nhật bản đồ ngay lập tức để hiển thị trạng thái mới
                updateMap();
                
                // Nếu xe đang trên lộ trình, tính lại lộ trình để bỏ qua thùng rác hỏng
                if (isSimulating && routeStatusEl.innerText === "Đã có lộ trình") {
                    logMessage("Phát hiện thùng hỏng trong lộ trình. Đang tính toán lại lộ trình.");
                    const remainingBins = bins.filter(b => b.fullness >= FULLNESS_THRESHOLD && !b.isCollected && !b.isBroken);
                    calculateOptimalRoute(remainingBins);
                }
            } else {
                logMessage(`Không tìm thấy thùng rác có ID: ${binId}.`);
            }
        };


        // Xử lý sự kiện nút
        startBtn.addEventListener('click', () => {
            if (!isSimulating) {
                isSimulating = true;
                simulationInterval = setInterval(updateSensorData, SIMULATION_INTERVAL);
                startBtn.innerText = "Dừng mô phỏng";
                startBtn.classList.remove('bg-blue-600');
                startBtn.classList.add('bg-red-600');
                optimizeBtn.disabled = false;
                reportIncidentBtn.disabled = false;
                reportBrokenBinBtn.disabled = false;
                logMessage("Bắt đầu mô phỏng thu thập dữ liệu.");
                truckStatusEl.innerText = "Đang chờ";
            } else {
                isSimulating = false;
                clearInterval(simulationInterval);
                if (movementInterval) clearInterval(movementInterval);
                startBtn.innerText = "Bắt đầu mô phỏng";
                startBtn.classList.remove('bg-red-600');
                startBtn.classList.add('bg-blue-600');
                optimizeBtn.disabled = true;
                reportIncidentBtn.disabled = true;
                reportBrokenBinBtn.disabled = true;
                logMessage("Dừng mô phỏng.");
            }
        });

        optimizeBtn.addEventListener('click', () => {
            logMessage("Người quản lý yêu cầu tối ưu hóa lộ trình.");
            const fullBins = findFullBins();
            calculateOptimalRoute(fullBins);
        });
        
        // Cập nhật xử lý sự kiện báo cáo sự cố để hiển thị modal
        reportIncidentBtn.addEventListener('click', () => {
            incidentModal.style.display = 'flex';
        });

        submitIncidentBtn.addEventListener('click', () => {
            const reason = incidentReasonInput.value;
            if (reason) {
                handleIncidentReport(reason);
            } else {
                logMessage("Lý do không được để trống.");
            }
            incidentReasonInput.value = '';
            incidentModal.style.display = 'none';
        });

        cancelIncidentBtn.addEventListener('click', () => {
            incidentReasonInput.value = '';
            incidentModal.style.display = 'none';
            logMessage("Hủy báo cáo sự cố.");
        });

        // Xử lý sự kiện cho nút và modal thùng rác hỏng
        reportBrokenBinBtn.addEventListener('click', () => {
            brokenBinModal.style.display = 'flex';
        });

        submitBrokenBinBtn.addEventListener('click', () => {
            const binId = parseInt(brokenBinIdInput.value, 10);
            if (!isNaN(binId)) {
                handleBrokenBinReport(binId);
            } else {
                logMessage("ID không hợp lệ. Vui lòng nhập một số.");
            }
            brokenBinIdInput.value = '';
            brokenBinModal.style.display = 'none';
        });

        cancelBrokenBinBtn.addEventListener('click', () => {
            brokenBinIdInput.value = '';
            brokenBinModal.style.display = 'none';
            logMessage("Hủy báo cáo thùng rác hỏng.");
        });

        // Khởi động ứng dụng khi trang được tải
        window.onload = function() {
            logMessage("Chào mừng bạn đến với demo. Hãy nhấn 'Bắt đầu mô phỏng' để khởi động hệ thống.");
            initMap();
        };
    </script>
</body>
</html>
